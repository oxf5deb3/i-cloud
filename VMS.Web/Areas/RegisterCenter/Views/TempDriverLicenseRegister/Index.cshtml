@inherits System.Web.Mvc.WebViewPage
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section HeaderStyle{
    <style type="text/css">
        body {
            font-size: 12px;
        }

        .textbox, .textbox-text {
            -moz-border-radius: 2px 2px 2px 2px;
            -webkit-border-radius: 2px 2px 2px 2px;
            border-radius: 2px 2px 2px 2px;
        }

        .form-horizontal .form-group {
            margin-left: 0px;
            margin-right: 0px;
        }

        .form-group {
            margin-bottom: 5px;
        }

        .red-star {
            color: red;
            font-size: 15px;
        }
    </style>
}
<div style="padding-left:10px;"><span style="color:blue">提示:</span>带<span class="red-star">*</span>号为必填项</div>
<hr style="margin-top:0px;" />
<table id="ls_table" style="table-layout:fixed;margin-left:10px;margin-right:10px;margin-top:20px;width:98%;height:350px;">
    <tr>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>临时驾驶证编号:</td>
        <td style="width:200px;"><input id="ls_no"></input></td>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>姓名:</td>
        <td style="width:100%;"><input id="name"></input></td>
    </tr>

    <tr>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>性别:</td>
        <td style="width:200px;"><input id="sex"></input></td>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>出生日期:</td>
        <td style="width:100%;"><input id="birth_date"></input></td>
    </tr>
    <tr>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>地区:</td>
        <td style="width:200px;"><input id="region"></input></td>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>国籍:</td>
        <td style="width:100%;"><input id="nation"></input></td>
    </tr>
    <tr>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>现住址:</td>
        <td style="width:200px;"><input id="now_addr"></input></td>
        <td style="width:120px;text-align:right;">原住址:</td>
        <td style="width:100%;"><input id="old_addr"></input></td>
    </tr>
    <tr>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>准驾车型:</td>
        <td style="width:200px;"><input id="car_type"></input></td>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>民族:</td>
        <td style="width:200px;"><input id="folk"></input></td>
        <!--
            <td style="width:120px;text-align:right;"><span class="red-star">*</span>考核员:</td>
        <td style="width:100%;"><input id="ck_man"></input></td>
        -->
    </tr>
    <!--
        <tr>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>考核结果:</td>
        <td style="width:200px;"><input id="ck_ret"></input></td>
        <td style="width:120px;text-align:right;">考核日期:</td>
        <td style="width:100%;"><input id="ck_date"></input></td>
    </tr>
    -->
    <tr>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>有效期:</td>
        <td colspan="3" style="width:200px;"><input id="start_date"></input>&nbsp;&nbsp;至&nbsp;&nbsp;<input id="end_date"></input></td>
    </tr>
  

    <tr>
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>人员信息像:</td>
        <td><button type="button" class="btn btn-info btn-sm" style="width:78px" id="select_user_info">拍照</button></td> 
        <td><img src="#" id="user_info_photo" style=" height: 80px;width: 100px;display:none" /></td>
        <td><input type="hidden" id="user_info_input" value="" /></td>


     </tr>

    <!--
        <tr >
        <td style="width:120px;text-align:right;"><span class="red-star">*</span>车辆照1:</td>
        <td><input id="car_image_1" name="name" class="easyui-filebox"
       data-options="buttonText:'选择照片',accept: 'image/*'" /></td>
        <td><img src=""  id="car_1_img"></td>
    </tr>
    -->




    <tr style="height:10px;"></tr>
    <tr>
        <td colspan="3"></td>
        <td style="padding-left:20px;">
            <button type="button" class="btn btn-info btn-sm" style="width:78px" id="ls_submit">提交</button>
        </td>
    </tr>
</table>

<div id="photoDialog">

    <table>

        <tr>

            <td><video id="userinfo_video" width="300" height="200" autoplay="autoplay"></video></td>
            <td><button type="button" class="btn btn-primary btn-sm" style="width:78px" onclick="takePhoto('userinfo_video', 'userinfo_canvas')">拍照</button></td>
            <td><button id="userinfo_clean" class="btn btn-primary btn-sm" onclick="cleanCanvas(this.id)" type="button">重置</button></td>
            <td><canvas id="userinfo_canvas" width="300" height="200" /></td>
        </tr>

    </table>



</div>

@section scripts{
    <script type="text/javascript">

        

     

        
        function initUI() {
            $('#folk').textbox({
                width: 180,
            });
            $('#ls_no').textbox({
                width: 180,
                readonly:true
            });
            $('#name').textbox({
                width: 180,
            });
            $('#sex').combobox({
                valueField: 'id',
                width: 180,
                panelHeight: 70,
                editable: false,
                textField: 'text',
                value:0,
                data: [{ id: 0, text: '男' }, { id: 1, text: '女' }]
            });
            $('#birth_date').datebox({
                width: 180,
                panelWidth: 180,
                panelHeight: 180,
                editable: false,
            });
            $('#region').combobox({
                valueField: 'region_no',
                width: 180,
                panelHeight: 50,
                editable: false,
                textField: 'region_name',
            });
            var url = '../../api/RegionApi/QueryAll';
            $.post(url, {}, 'json')
            .success(function (ret) {
                if (ret.success) {
                    $('#region').combobox('loadData', ret.data);
                }
            });
            $('#nation').combobox({
                valueField: 'id',
                width: 180,
                panelHeight: 70,
                editable: false,
                textField: 'text',
                value: 1,
                data: [{ id: 1, text: '缅甸' }]
            });

            $('#now_addr').textbox({
                width: 180,
            });
            $('#old_addr').textbox({
                width: 180,
            });
            $('#car_type').textbox({
                width: 180,
                
            });
            
            
            var now = new Date();
            $('#start_date').datebox({
                width: 180,
                panelWidth: 180,
                panelHeight: 180,
                editable: false,
                required: true,
                value: now.pattern('MM/dd/yyyy'),
                onSelect: function (date) {
                    var endDate = new Date(date.getFullYear(), date.getMonth() + 3, date.getDate());
                    console.log(endDate.pattern('MM/dd/yyyy'))
                    $('#end_date').datebox('setValue', endDate.pattern('MM/dd/yyyy').toString());
                }
            });
            var end = new Date(now.getFullYear(), now.getMonth() + 3, now.getDate());
            $('#end_date').datebox({
                width: 180,
                panelWidth: 180,
                panelHeight: 180,
                editable: false,
                required: true,
                value: end.pattern('MM/dd/yyyy'),
            });
        }
       

        function getData() {
            var data = {};
            data.birthday = $("#birth_date").textbox("getValue");
            data.permitted_card_type_no = $("#car_type").textbox("getValue");
           
            data.end_date = $("#end_date").textbox("getValue");
            data.id_no = $("#ls_no").textbox("getValue");
            data.name = $("#name").textbox("getValue");
            data.nation_no = $("#nation").textbox("getValue");
            data.now_addr = $("#now_addr").textbox("getValue");
            data.old_addr = $("#old_addr").textbox("getValue");
            data.region_no = $("#region").combobox("getValue");
            data.sex = $("#sex").combobox("getValue");
            data.start_date = $("#start_date").textbox("getValue");
            data.folk = $("#folk").textbox("getValue");
            data.user_photo_base64 = $("#user_info_photo").attr("src");

            return data;
        }

        function initCarNo() {
            var url = "../../api/DriverLicenseApi/initCarNo";
            //0=临时驾照
            $.post(url, {id_no:0}, 'json')
                        .success(function (ret) {
                            if (ret.success) {
                                $("#ls_no").textbox("setValue",ret.message);
                            } else {
                                alert("初始化证件编码失败!请刷新页面!");
                            }
                        });
        }


        function validata() {
            //校验 非空
            var message = {
                type: true,
                message:""
            };
            if (!isNull($("#birth_date").textbox("getValue" ))) {
                message.type = false;
                message.message = "必须填写出生日期!";
                return message;
            }
            if (!isNull($("#car_type").textbox("getValue"))) {
                message.type = false;
                message.message = "必须选择准驾车型!";
                return message;
            }
            
   
            //姓名
            if (!isNull($("#name").textbox("getValue"))) {
                message.type = false;
                message.message = "必须填写姓名!";
                return message;
            }
            //国籍
            if (!isNull($("#nation").combobox("getValue"))) {
                message.type = false;
                message.message = "必须选择国籍!";
                return message;
            }
           
            //地区
            if (!isNull($("#region").combobox("getValue"))) {
                message.type = false;
                message.message = "必须选择地区!";
                return message;
            }
            //性别
            if (!isNull($("#sex").combobox("getValue"))) {
                message.type = false;
                message.message = "必须填写性别!";
                return message;
            }
           
            if (!isNull($("#user_info_input").attr("value"))) {
                message.type = false;
                message.message = "必须上传人员照片信息!";
                return message;
            }

            //现住址
            if (!isNull($("#now_addr").textbox("getValue"))) {
                message.type = false;
                message.message = "必须填写现住址!";
                return message;
            }

            //
            if (!isNull($("#folk").textbox("getValue"))) {
                message.type = false;
                message.message = "必须填写民族!";
                return message;
            }

            

            return message;

        }



        //初始化人员照片信息采集对话框
        function initPhotoDialog() {
            $('#photoDialog').dialog({
                title: '人员照片信息采集',
                width: 800,
                height: 500,
                closed: true,
                cache: false,
                onOpen: function () {
                   initPhoto("userinfo_video");//初始化摄像头组件
                },
                onClose: function () {
                    cleanCanvas("userinfo_canvas");//清除缓存
                    closePhoto("userinfo_video");//关闭摄像头
                },
                buttons:[{
                    text:'确定',
                    handler:function(){
                        var data = getCanvasForBase64("userinfo_canvas");//获取照片转为base64
                        $("#user_info_photo").attr("src", data);//存储为缩略图
                        $("#user_info_input").attr("value", data);
                        $("#user_info_photo").css("display", "");
                        $("#photoDialog").dialog("close");//关闭dialog
                        cleanCanvas("userinfo_canvas");//清除缓存
                        closePhoto("userinfo_video");//关闭摄像头
                        

                    }
                },{
                    text:'取消',
                    handler:function(){
                        cleanCanvas("userinfo_canvas");//清除缓存
                        closePhoto("userinfo_video");//关闭摄像头
                        $("#photoDialog").dialog("close");//关闭dialog
                       
                    }
                }]
            });
        }


        

        $(function () {


            initUI();
            initCarNo();
            initPhotoDialog();



            
            $("#select_user_info").click(function () {
               
                $("#photoDialog").dialog("open");

            });



            $("#ls_submit").click(function () {

                //表单提交校验
                var message = validata();

                if(!message.type){
                    alert(message.message);
                    return;
                }

                //获取表单数据
                var data = getData();
                var url = "../../api/DriverLicenseApi/addLsDriverLicense";
           
                if(data!=undefined){
                    $.post(url, data, 'json')
                        .success(function (ret) {
                            if(ret.success){
                                alert("添加成功!");
                                location.reload();
                            } else {
                                alert("添加失败!");
                            }
                        });
                }
            });
        })
    </script>
}

