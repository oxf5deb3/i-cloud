@inherits System.Web.Mvc.WebViewPage
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section HeaderStyle{
    <style type="text/css">
        html, body {
            font-size: 12px;
            height: 85%;
        }

        .textbox, .textbox-text {
            -moz-border-radius: 2px 2px 2px 2px;
            -webkit-border-radius: 2px 2px 2px 2px;
            border-radius: 2px 2px 2px 2px;
        }

        #query-params {
            width: 100%;
        }

        label {
            width: 100px;
        }

        form input {
            width: 500px;
        }

        .red-star {
            color: red;
        }
    </style>
}

<div class="q-condition">
    <div class="btn-container">
        <a href="#" onclick="edit()" class="easyui-linkbutton" data-options="iconCls:'icon-edit'" style="width:60px">编辑</a>
        <a href="#" onclick="del()" class="easyui-linkbutton" data-options="iconCls:'icon-remove'" style="width:60px">删除</a>
        <a href="#" onclick="showPic()" class="easyui-linkbutton" data-options="iconCls:'icon-pic'" style="width:80px">查看图片</a>
    </div>
    <hr />
    <table id="query-params">
        <tr>
            <td><label>编号：</label><input class="easyui-textbox" id="id" /></td>
            <td><label>设备信息：</label><input class="easyui-textbox" id="name" /></td>
            <td><label>安装地址：</label><input class="easyui-textbox" id="address" /></td>
            <td><label>安装时间(起)：</label><input class="easyui-datetimebox" id="timeBegin" /></td>
            <td><label>安装时间(止)：</label><input class="easyui-datetimebox" id="timeEnd" /></td>
        </tr>
        <tr>
            <td><label>负责人：</label><input class="easyui-textbox" id="liable" /></td>
            <td colspan="3"></td>
            <td><a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search'" onclick="query()" style="width:80px">查询</a></td>
        </tr>
    </table>
</div>
<hr />

<table id="dataGrid"></table>

<div id="dlg" class="easyui-dialog" style="width:800px;" data-options="closed:true,modal:true,border:'thin',buttons:'#dlg-buttons'">
    <form id="accident" method="post" novalidate style="margin:0; padding:20px 50px">
        <input type="hidden" name="id" required />
        <div class="item" id="item-div"></div>
        <div class="item">
            <label><span class="red-star">*</span>负责人：</label>

            <input class="easyui-textbox" id="liable" name="liable" required>
        </div>
        <div class="item">
            <label>
                <span class="red-star">*</span>安装地址：
            </label>
            <input class="easyui-textbox" data-options="multiline:true" style="height:60px" name="address" id="address" required>
        </div>
        <div class="item">
            <label>
                <span class="red-star">*</span>安装时间：
            </label>
            <input class="easyui-datetimebox" id="datetime" name="datetime" required>
        </div>
        <div class="item">
            <label>
                <span class="red-star">*</span>用途描述：
            </label>
            <input class="easyui-textbox" data-options="multiline:true" style="height:60px" name="desc" id="desc" required>
        </div>
    </form>
</div>
<div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconcls="icon-ok" onclick="save()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')" style="width:90px">取消</a>
</div>

<div id="dlg-upload" class="easyui-dialog" style="width:600px;height:300px"
     data-options="closed:true, title:'添加图片',buttons:'#upload-tb',modal:true">
    <form id="upload">
        <div class="item">
            <label>
                <span class="red-star">*</span>图片：
            </label>
            <input type="file" name="files" id="files" accept="image/png, image/jpeg, image/jpg" multiple required />
        </div>
    </form>
</div>
<div id="upload-tb">
    <a href="javascript:upload()" class="easyui-linkbutton">上传</a>
    <a href="javascript:$('#dlg-upload').dialog('close')" class="easyui-linkbutton">取消</a>
</div>

<div id="dlg-img" class="easyui-dialog" title="图片" style="width: 89%; height:100%; padding: 10px; text-align: center;"
     data-options="
     closed:true,
     modal:true,
     iconCls: 'icon-save' ,
     toolbar: [{
     text:'添加图片',
     iconCls:'icon-add',
     handler:function(){
     $('#dlg-upload').dialog('open').dialog('center');
     }
     },'-',{
     text:'删除图片',
     iconCls:'icon-remove',
     handler:function(){
     if (imgNames) {
     if (imgNames.length>
    2) {
    imgNames.splice(imgIndex, 1);
    imgIndex = 0;
    loadImg(imgNames[imgIndex]);
    }
    }
    }
    },'-',{
    text:'上一张',
    handler:function(){
    if (imgIndex > 0 && imgNames && imgNames.length > 1) {
    imgIndex--;
    loadImg(imgNames[imgIndex]);
    }
    }
    },'-',{
    text:'下一张',
    handler:function(){
    if (imgIndex >= 0 && imgNames && imgNames.length > imgIndex + 1 && imgNames[imgIndex + 1] != '') {
    imgIndex++;
    loadImg(imgNames[imgIndex]);
    }
    }
    }],
    buttons: [{
    text:'保存',
    iconCls:'icon-ok',
    handler:function(){
    $.ajax({
    url: '/api/FireControlApi/ModifyEquipmentImgs',
    method: 'post',
    dataType: 'json',
    data: {
    id: id,
    imgs: imgNames.join(',')
    },
    success: function(result) {
    if (result.success) {
    $.messager.alert('提示','修改成功' );
    $('#dlg-img').dialog('close');
    $('#dataGrid').datagrid('reload');
    } else {
    $.messager.alert('提示', '修改失败' );
    }
    }
    });
    }
    },{
    text:'取消',
    handler:function(){
    $('#dlg-img').dialog('close');
    }
    }]
    ">
    <img id="img-show" />
</div>


@section scripts{
    <script type="text/javascript">
        var imgNames;
        var imgIndex = -1;
        var id = -1;
        $('#dataGrid').datagrid({
            columns: [[
                { field: 'ck', checkbox: true },
                { field: 'id', title: '编号', halign: 'center', align: 'left' },
                { field: 'name', title: '设备信息', halign: 'center', align: 'left' },
                { field: 'address', title: '安装地址', halign: 'center', align: 'left' },
                { field: 'datetime', title: '安装时间', halign: 'center', align: 'left' },
                { field: 'desc', title: '用途描述', halign: 'center', align: 'left' },
                { field: 'liable', title: '负责人', halign: 'center', align: 'left' },
                { field: 'operId', title: '登记人员', halign: 'center', align: 'left' },
                { field: 'operDate', title: '登记时间', halign: 'center', align: 'left' },
                { field: 'modifyOperId', title: '最近修改人员', halign: 'center', align: 'left' },
                { field: 'modifyDate', title: '最近修改时间', halign: 'center', align: 'left' },
                { field: 'imgs', hidden: true }
            ]],
            url: '/api/FireControlApi/ListEquipment',
            //toolbar: '#toolbar',
            height: $(window).height() -$('.q-condition').outerHeight()- 30,
            idField: 'id',
            pagination: true,
            pageList: [10, 20, 50],
            fitColumns: true,
            striped: true,
            showHeader: true,
            queryParams: {
                address: $('#address').val(),
                timeBegin: $('#timeBegin').val(),
                timeEnd: $("#timeEnd").val(),
                name: $('#name').val(),
                liable: $('#liable').val()
            }
        });
        function showPic() {
            var row = $('#dataGrid').datagrid('getSelected');
            if (row) {
                var imgUrl = row.imgs;
                id = row.id;
                if (imgUrl && imgUrl.length > 0) {
                    imgNames = imgUrl.split(",");

                    if (imgNames && imgNames.length > 0) {
                        imgIndex = 0;
                        loadImg(imgNames[0]);
                    }
                }
                $('#dlg-img').dialog('open').dialog('center');
            } else {
                $.messager.alert("提示", "请先选择一条记录");
            }
        }

        function loadImg(name) {
            if (name && !name == "" && name.length > 4) {
                $('#img-show').prop('src', '/api/FireControlApi/getReadImg?type=equipment&imgName=' + name);
            }
        }

        function upload() {
            var formData = new FormData(document.getElementById("upload"));
            formData.append("id", id);
            $.ajax({
                url: "/api/FireControlApi/AppendEquipmentImg",
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                success: function (ret) {
                    if (ret.success) {
                        $.messager.alert('提示', '添加成功');
                        $('#files').val('');
                        $('#dlg-upload').dialog('close');
                        $('#dlg-img').dialog('close');
                        $('#dataGrid').datagrid('reload');
                    } else {
                        $.messager.alert('提示', '添加失败');
                    }
                }
            });
        }
        function query() {
            $('#dataGrid').datagrid('load', {
                address: $('#address').val(),
                timeBegin: $('#timeBegin').val(),
                timeEnd: $("#timeEnd").val(),
                name: $('#name').val(),
                liable: $('#liable').val()
            });
        }
        function del() {
            var rows = $('#dataGrid').datagrid('getSelections');
            if (rows && rows.length > 0) {
                var ids = new Array(rows.length);
                for (var i = 0; i < rows.length; i++) {
                    ids[i] = rows[i].id;
                }
                $.messager.confirm('提示', '请确定要删除编号为' + ids.join(" , ") + '的记录？', function (r) {
                    if (r) {
                        $.ajax({
                            url: '/api/FireControlApi/DelEquipment',
                            method: 'post',
                            dataType: 'json',
                            data: { ids: ids.join(",") },
                            success: function (result) {
                                if (result.success) {
                                    $.messager.alert("提示", "删除成功");
                                    $('#dataGrid').datagrid('reload');
                                } else {
                                    $.messager.alert("提示", "删除失败");
                                }
                            }
                        });
                    }
                });
            } else {
                $.messager.alert("提示", "请先选择至少一条记录");
            }

        }


        function edit() {
            $('.add-item').remove();
            var row = $('#dataGrid').datagrid('getSelected');
            if (row) {
                $('#accident').form('load', row);
                var names = row.name.split("=>");
                if (names.length > 0) {
                    for (var i = 0; i < names.length; i++) {
                        if (i == 0) {
                            $('#item-div').after("<div class='item add-item' id='item-info'><label><span class='red-star'>*</span>设备信息：</label><input class='easyui-textbox' name='name' value='" + names[i] + "' required><a href='javascript:addItem()' class='easyui-linkbutton' plain='true' iconcls='icon-add'></a></div>");
                        } else {
                            $('#item-info').after("<div class='item add-item'><label><span class='red-star'></span></label><input class='easyui-textbox' name='name' value='" + names[i] + "' required></div>");
                        }
                    }
                }
                $('#datetime').prev().val(row.datetiem);
                $('#dlg').dialog('open').dialog('center').dialog('setTitle', '修改记录');
            } else {
                $.messager.alert("提示", "请先选择一条记录");
            }
        }

        function save() {
            if ($('#accident').form('validate')) {
                var formData = new FormData(document.getElementById("accident"));
                formData.delete('name');
                var names = document.getElementsByName('name');
                var name = '';
                for (var j = 0; j < names.length; j++) {
                    name += names[j].value;
                    if (j < names.length - 1) {
                        name += '=>';
                    }
                }
                formData.append('name', name);
                $.ajax({
                    url: '/api/FireControlApi/ModifyEquipment',
                    method: 'post',
                    dataType: 'json',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (result) {
                        if (result.success) {
                            $.messager.alert("提示", "修改成功");
                            $('#dlg').dialog('close');        // close the dialog
                            $('#dataGrid').datagrid('reload');
                        } else {
                            $.messager.alert("提示", "修改失败");
                        }
                    }
                });
            }
        }

        function addItem() {
            $('#item-info').after("<div class='item add-item'><label><span class='red-star'></span></label><input class='easyui-textbox' name='name' required></div>");
            $.parser.parse($('#accident'));
        }
    </script>
}