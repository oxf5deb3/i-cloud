@inherits System.Web.Mvc.WebViewPage
@{
    Layout="~/Views/Shared/_Layout.cshtml";
}
@section HeaderStyle{
<style type="text/css">
    .textbox,.textbox-text
    {
      -moz-border-radius: 2px 2px 2px 2px;
     -webkit-border-radius: 2px 2px 2px 2px;
      border-radius: 2px 2px 2px 2px;
    }
    .btn-reset{
      padding-top:4px;
      padding-bottom:4px;
      font-size:8px;
    }
</style>
}
<table id="dg"></table>
<div id="toolbar" style="display:none">
    <a href="#" class="easyui-linkbutton" plain="true" onclick="add()"><i class="glyphicon glyphicon-plus"></i>新增</a>
    <a href="#" class="easyui-linkbutton" plain="true" onclick="edit()"><i class="glyphicon glyphicon-pencil"></i>编辑</a>
    <a href="#" class="easyui-linkbutton" plain="true" onclick="del()"><i class="glyphicon glyphicon-minus"></i>删除</a>
</div>
<div id="dlg" class="easyui-dialog" style="display:none;width:600px;height:400px;padding:0px"
     closed="true" buttons="#dlg-buttons">
    <div id="tt" class="easyui-tabs" style="width:100%;height:310px;">
        <div title="基本信息" style="padding:20px;display:none;">
            <table style="width:100%;height:130px;table-layout:fixed;border-collapse: collapse;">
                <tr>
                    <td style="width:80px;text-align:right;"><label>角色名称：</label></td>
                    <td style="width:100%;"><input id="role_name" type="text" /></td>
                </tr>
                <tr>
                    <td style="width:80px;text-align:right;"><label>状&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;态：</label></td>
                    <td>
                        <label>
                            <input type="radio" name="status" id="ck_active" value="0" checked>
                            正常
                        </label>
                        <label>
                            <input type="radio" name="status" id="ck_stop" value="1">
                            停用
                        </label>
                    </td>
                </tr>
               
                <tr>
                    <td style="width:80px;text-align:right;"><label>备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：</label></td>
                    <td><input id="memo" type="text" /></td>
                </tr>
            </table>
            <div style="color:blue;margin-top:10px;">注意：角色名称不能与已有角色名相同！</div>
        </div>
        <div title="角色成员" data-options="closable:false" style="overflow:auto;display:none;">
            <table style="table-layout:fixed;width:100%;height:100%;">
                <tr style="height: 20px;border-bottom:2px solid #c7c7c7"><td colspan="2"><span style="color:red;">提示：</span><span style="color:blue;">双击选中</span>左侧表格当前行用户到右侧表格作为该角色下成员,同时双击右侧表格数据可进行删除操作.</td></tr>
                <tr>
                    <td style="width:50%">
                        <table id="dgAllUser" style="height:100%;width:100%;"></table>
                    </td>
                    <td style="width:50%">
                        <table id="dgSelectedUser" style="height:100%;width:100%;"></table>
                    </td>
                </tr>
            </table>
        </div>
        <div title="所属组" data-options="closable:false" style="overflow:auto;display:none;">
            <table style="table-layout:fixed;width:100%;height:100%;">
                <tr style="height: 20px;border-bottom:2px solid #c7c7c7"><td colspan="2"><span style="color:red;">提示：</span><span style="color:blue;">双击选中</span>左侧表格当前行用户到右侧表格作为该组下成员,同时双击右侧表格数据可进行删除操作.</td></tr>
                <tr>
                    <td style="width:50%">
                        <table id="dgAllGroup" style="height:100%;width:100%;"></table>
                    </td>
                    <td style="width:50%">
                        <table id="dgSelectedGroup" style="height:100%;width:100%;"></table>
                    </td>
                </tr>
            </table>
        </div>
    </div>
   
</div>
<div id="dlg-buttons" style="display:none;">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" onclick="save()" style="width:90px"><i class="glyphicon glyphicon-ok"></i>确定</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="javascript:$('#dlg').dialog('close')" style="width:90px"><i class="glyphicon glyphicon-remove"></i>取消</a>
</div>

@section scripts{
<script type="text/javascript">
    function initUserTabGrid(){
       var gridall=$('#dgAllUser');
       var gridselected = $('#dgSelectedUser');
       var url="../../api/UserApi/QueryAll";
       var gridOpts = {
           url:url,
           pagination:false,
           pageSize:15,
           pageList:[15,20,30,40,50],
           checkOnSelect:true,
           striped:true,
           showHeader:true,
           singleSelect:true,
           rownumbers:true,
           onDblClickRow:function(index,row){
                var rightRow = {id:row.id,user_id:row.user_id,user_name:row.user_name};
                var rightAllRow = gridselected.datagrid('getRows');
                var index=-1;
                $.each(rightAllRow,function(inx,el){
                       if(rightRow.id==el.id){index=inx;return false;}
                });
                if(index>=0){
                  gridselected.datagrid('selectRow',index);
                }else{
                  gridselected.datagrid('appendRow',rightRow);
                }

           },
           onLoadError:function(){},
           columns:[[
               {field:'user_id',title:'账号',width:60,halign:'center',align:'left'},
               {field:'user_name',title:'名称',width:90,halign:'center',align:'left'},
               {field:'status',title:'状态',width:90,halign:'center',align:'left',formatter:function(value,row,index){
                       if(value=='0') return '<span style="color:blue">正常</span>';
                       return '<span style="color:red">停用</span>';
                 }}
           ]]
       };
       gridall.datagrid(gridOpts);
       gridOpts = {
           pagination:false,
           checkOnSelect:true,
           striped:true,
           showHeader:true,
           checkbox:true,
           singleSelect:true,
           rownumbers:true,
           onDblClickRow:function(index,row){
             $(this).datagrid('deleteRow',index);
           },
           onLoadError:function(){},
           width:'100%',
           height:'100%',
           columns:[[
               {field:'user_id',title:'账号',width:80,halign:'center',align:'left'},
               {field:'user_name',title:'名称',width:100,halign:'center',align:'left'}
           ]]
       };
      gridselected.datagrid(gridOpts);
    }
     function initGroupTabGrid(){
       var gridall=$('#dgAllGroup');
       var gridselected = $('#dgSelectedGroup');
       var url="../../api/UserGroupApi/QueryAllGroup";
       var gridOpts = {
           url:url,
           pagination:false,
           pageSize:15,
           pageList:[15,20,30,40,50],
           checkOnSelect:true,
           striped:true,
           showHeader:true,
           singleSelect:true,
           rownumbers:true,
           onDblClickRow:function(index,row){
                var rightRow = {id:row.id,group_name:row.group_name};
                var rightAllRow = gridselected.datagrid('getRows');
                var index=-1;
                $.each(rightAllRow,function(inx,el){
                       if(rightRow.id==el.id){index=inx;return false;}
                });
                if(index>=0){
                  gridselected.datagrid('selectRow',index);
                }else{
                  gridselected.datagrid('appendRow',rightRow);
                }

           },
           onLoadError:function(){},
           columns:[[
               {field:'group_name',title:'组名称',width:100,halign:'center',align:'left'},
               {field:'status',title:'状态',width:50,halign:'center',align:'left',formatter:function(value,row,index){
                       if(value=='0') return '<span style="color:blue">正常</span>';
                       return '<span style="color:red">停用</span>';
                 }},
               {field:'memo',title:'备注',width:120,halign:'center',align:'left'},
           ]]
       };
       gridall.datagrid(gridOpts);
       gridOpts = {
           pagination:false,
           checkOnSelect:true,
           striped:true,
           showHeader:true,
           checkbox:true,
           singleSelect:true,
           rownumbers:true,
           onDblClickRow:function(index,row){
             $(this).datagrid('deleteRow',index);
           },
           onLoadError:function(){},
           width:'100%',
           height:'100%',
           columns:[[
               {field:'group_name',title:'组名称',width:100,halign:'center',align:'left'}
           ]]
       };
      gridselected.datagrid(gridOpts);
    }
    function getData(){
        var role_name = $('#role_name').textbox('getValue');
        var status = $('#ck_active').is(':checked')==true?'0':'1';
        var memo = $('#memo').textbox('getValue');
        var roleusers = $('#dgSelectedUser').datagrid('getRows');
        var rolegroups = $('#dgSelectedGroup').datagrid('getRows');
        return {role_name:role_name,status:status,memo:memo,users:roleusers,groups:rolegroups};
    }
    function setData(data){
        $('#role_name').textbox('setValue',data.role_name);
        $('#ck_active').attr("checked",true);
        if('0'!=data.status){
          $('#ck_stop').attr("checked",true);
        }
        $('#memo').textbox('setValue',data.memo);

    }
    function setEnable(enable){
        if(enable){
           $('#role_name').textbox('enable');
        }else{
           $('#role_name').textbox('disable');
        }

    }
    function clear(){
        $('#role_name').textbox('setValue','');
        $('#ck_active').attr("checked",true);
        $('#memo').textbox('setValue','');
        $('#dgSelectedUser').datagrid('loadData',[]);
        $('#dgSelectedGroup').datagrid('loadData',[]);
    }
    function add(){
        clear();
        setEnable(true);
        $('#dlg').dialog('open').dialog('setTitle','新增角色');
        $('#dlg').dialog('options').status=1;
       // initTabGrid();
    }
    function edit(){
        var selectedRow = $('#dg').datagrid('getSelected');
        if(selectedRow==null) {
          $.messager.alert('提示','请先选中一行需要编辑的数据!','info');
          return ;
        }
        clear();
        setData(selectedRow);
     $.post('/api/RoleApi/FindRoleUserById',{role_id:selectedRow.id},'json')
        .success(function(ret){
           if(ret.success){
              $('#dgSelectedUser').datagrid('loadData',ret.data);
           }
        })
     $.post('/api/RoleApi/FindRoleGroupById',{role_id:selectedRow.id},'json')
        .success(function(ret){
           if(ret.success){
              $('#dgSelectedGroup').datagrid('loadData',ret.data);
           }
        })

        setEnable(false);
        $('#dlg').dialog('open').dialog('setTitle','编辑角色');
        $('#dlg').dialog('options').status=0;
    }
    function del(){
        var checked = $('#dg').datagrid('getChecked');
        if(checked.length<=0)
        {
           $.messager.alert('提示','请先勾选需要删除的数据!','info');
           return ;
        }
         url = "/api/RoleApi/Del";
        $.post(url,{deleted:checked},function(ret){
              if(ret.success)
             {
                $.messager.alert('提示','删除的数据成功!','info');
              }else{
                  if($.trim(ret.message)!='')
                 {
                      $.messager.alert('提示',ret.message,'info');
                  }else{
                      $.messager.alert('提示','删除的数据失败!','info');
                  }
            }
         });
    }
   function save(){
       var data = getData();
       var url = "/api/RoleApi/Add";
       var msg = "添加";
       var status = $('#dlg').dialog('options').status;
       if(status!='1')
      {
         msg = "修改";
         url="/api/RoleApi/Edit";
         data.id = $('#dg').datagrid('getSelected').id;
         data.create_id = $('#dg').datagrid('getSelected').create_id;
       }

        $.post(url,data,function(ret){
           if(ret.success){
            reload();
            $.messager.alert('提示',msg+'成功!','info');
           }else{
             if($.trim(ret.message)!=''){
                 $.messager.alert('提示',ret.message,'info');
              }else{
                 $.messager.alert('提示',msg+'失败!','info');
              }
           }
        });

    }
    function reload(){
       $('#dg').datagrid('reload');
    }
    var resizeTimer = null;
    function resize(){
     $(window).bind('resize', function (){
        if (resizeTimer) clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function(){

                $('#dg').datagrid('resize',{width:'100%'});
        } , 500);
      });
    }
     function initDialog(){
         $('#role_name').textbox({
               width:'100%',
               required:true,
               });
         $('#ck_active').attr("checked",true);
         $('#memo').textbox({
               width:'100%',
              multiline:true,
              height:'50px'
               });
         $('#dlg').dialog({
           onClose:function(){ reload();}
         });
        }
     function initGrid(){
     var height = $(window).height()-5;
     var url = "/api/RoleApi/Query";
     $('#dg').datagrid({
           url:url,
           pagination:true,
           pageSize:15,
           pageList:[15,20,30,40,50],
           checkOnSelect:true,
           striped:true,
           showHeader:true,
           checkbox:true,
           //singleSelect:true,
           rownumbers:true,
           onLoadError:function(){},
           toolbar: '#toolbar',
           width:'100%',
           height:height,
           columns:[[
               {field:'ck',checkbox:true},
               {field:'role_name',title:'角色名称',width:80,halign:'center',align:'left'},
               {field:'status',title:'状态',width:80,halign:'center',align:'left',
                 formatter:function(value,row,index){
                    if('0'==value) return '正常';
                     return '停用';
                }},
               {field:'memo',title:'备注',width:150,halign:'center',align:'left'}
           ]]
     });
    }
     $(function(){
     initGrid();
     initDialog();
     initUserTabGrid();
     initGroupTabGrid();
     resize();
     });

</script>



}